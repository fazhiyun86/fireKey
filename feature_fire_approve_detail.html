<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>动火审批</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" href="css/feature_fire_approve.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav titBackg">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">动火审批</h1>
		</header>
		<div class="mui-content fire-approve-detail">
			<div id="segmentedControl" class="mui-segmented-control mui-segmented-control-inverted">
				<a class="mui-control-item mui-active" href="#item1">动火申请</a>
				<a class="mui-control-item" href="#item2">特种操作证</a>
			</div>
			<div class="mui-scroll-wrapper">
		    	<div class="mui-scroll">
					<div style="padding: 10px;">
						<div id="item1" class="mui-control-content mui-active">
							<div class="fire-content">
								<p class="content-flex">
									<label class="content-flex-tit">证书编号：</label>
									<span class="content-flex-val" id="approval.PermitCode"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">项目工程：</label>
									<span class="content-flex-val" id="approval.ProjectCompanyName"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">施工单位：</label>
									<span class="content-flex-val" id="approval.ApplyCompanyName"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">动火区域：</label>
									<span class="content-flex-val" id="approval.FireWorkRegion"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">动火位置：</label>
									<span class="content-flex-val" id="approval.FirePositions"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">消防器材：</label>
									<span class="content-flex-val" id="approval.FireApparatus"></span>
								</p>
								<div class="content-flex flex-box">
									<p class="col-half">
										<label class="content-flex-tit">作业级别：</label>
										<span class="content-flex-val" id="approval.JobLevel"></span>
									</p>
									<p class="col-half">
										<label class="content-flex-tit">作业种类：</label>
										<span class="content-flex-val" id="approval.JobType"></span>
									</p>
								</div>
								<div  class="content-flex">
									<p class="col-half">
										<label class="content-flex-tit">作业项目：</label>
										<span class="content-flex-val" id="approval.ProjectName"></span>
									</p>
									<p class="col-half">
										<label class="content-flex-tit">看火人员：</label>
										<span class="content-flex-val" id="approval.SupervisionUserName"></span>
									</p>
								</div>
								<p class="content-flex">
									<label class="content-flex-tit">动火时间：</label>
									<span class="content-flex-val" id="approval.ValidTime"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">动火申请：</label>
									<span class="content-flex-val" id="approval.ApplyUserName"></span>
								</p>
								<p class="content-flex">
									<label class="content-flex-tit">申请时间：</label>
									<span class="content-flex-val" id="approval.ApplyTime"></span>
								</p>
							</div>
							<div class="fire-content mart5">
								<p class="content-flex">
									<label class="content-flex-tit">审批结果：</label>
									<span class="content-flex-val">
										<label class="radio-label" for="agree"><input id="agree" name="AuditExplain" type="radio" value="0"/>通过</label>
										<label class="radio-label" for="refuse"><input id="refuse" name="AuditExplain" type="radio" value="1"/>拒绝</label>
									</span>
								</p>
								<div class="content-flex block-box">
									<span class="content-flex-tit">审批意见：</span>
									<textarea rows="3" id="AuditDescript" placeholder="您可以输入审批意见"></textarea>
								</div>
								<button id="AuditBtn" class="mui-btn mui-btn-danger mui-btn-block">确定</button>
							</div>
						</div>
							
						<div id="item2" class="mui-control-content">
							<div class="fire-content">
								<h5 class="certificate-title">特种作业操作证</h5>
								<div class="content-detail">
									<label for="CertificateCode">证号：</label>
									<div class="content-input">
										<input id="CertificateCode" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="CertificateName">证件名称：</label>
									<div class="content-input">
										<input id="CertificateName" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="IssuingAuthority">发证机关：</label>
									<div class="content-input">
										<input id="IssuingAuthority" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="ProjectCompanyName">工程单位：</label>
									<div class="content-input">
										<input id="ProjectCompanyName" type="text" />
									</div>
								</div>
								<div class="flex-box">
									<div class="content-detail col-half">
										<label for="UserName">姓名：</label>
										<div class="content-input">
											<input id="UserName" type="text" />
										</div>
									</div>
									<div class="content-detail col-half">
										<label for="Gender">性别：</label>
										<div class="content-input">
											<input id="Gender" type="text" />
										</div>
									</div>
								</div>
								<div class="content-detail">
									<label for="JobProject">作业类别：</label>
									<div class="content-input">
										<input id="JobProject" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="CertificateDate">初领日期：</label>
									<div class="content-input">
										<input id="CertificateDate" type="text" />
									</div>	
								</div>
								<div class="flex-box">
									<div class="content-detail col-more">
										<label for="">有限期限：</label>
										<div class="content-input">
											<input id="ValidityStartDate" type="text" />
										</div>	
									</div>
									<div class="content-detail col-less">
										<label class="center">至</label>
										<div class="content-input">
											<input id="ValidityEndDate" type="text" />
										</div>	
									</div>
								</div>
								<div class="content-detail">
									<label for="ReviewDate">复审日期：</label>
									<div class="content-input">
										<input id="ReviewDate" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="IDCard">身份证号：</label>
									<div class="content-input">
										<input id="IDCard" type="text" />
									</div>
								</div>
								<div class="content-detail">
									<label for="Mobile">手机号码：</label>
									<div class="content-input">
										<input id="Mobile" type="number" />
									</div>
								</div>
								<div class="content-detail">
									<label for="Remark">备注：</label>
									<div class="content-input">
										<input id="Remark" type="text"/>
									</div>
								</div>
								<div class="content-detail block-box">
									<label for="Url">证件照片：</label>
									<div id="Url">
										<!--<img src="images/01-in-1080.png" />-->
									</div>
								</div>
								<div class="content-detail">
									<label for="Mobile">证件审核：</label>
									<div class="content-input">
										<span id="AuditUserName"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span id="ProjectCompanyName"></span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>	
			</div>
		</div>
		<script>window.FastClick = true;</script> <!--解决radio，点击第二个，选中第一个radio的问题-->
		<script src="js/mui.min.js"></script>
		<script src="js/feature_common.js"></script>
		<script>
		mui.init({
			swipeBack: false,
			beforeback: function(){
				var list = plus.webview.currentWebview().opener();
		        mui.fire(list, 'refresh');
		        return true;
			}
		});
		var scroll = mui(".mui-scroll-wrapper").scroll();
		mui("#segmentedControl").on('tap', '.mui-control-item', function(e){
			scroll.scrollTo(0, 0);
		});
		
		mui.plusReady(function(){
			plus.nativeUI.showWaiting();
			var currWebView = plus.webview.currentWebview();
			var PermitID = currWebView.info.PermitID;
			var RegisterID = currWebView.info.RegisterID;
			
			getApprovalData(PermitID);
			addEvent(PermitID);
			
			getCertificateData(RegisterID);
		});
		// 获取动火申请详情
		function getApprovalData(PermitID) {
			var url = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/GetData/FW_GetFireWorkPermitDetail_Client_IIS?dataKey=00-00-00-00';
			var data = {
				PermitID: PermitID
			};
			mui.ajax(url, {
				type: 'get',
				dataType: 'json',
				data: data,
				success: function(response) {
					plus.nativeUI.closeWaiting();
					var data = response.DataSource.Tables[0].Datas;
					console.log('动火申请详情', JSON.stringify(data));
					setApprovalValue(data);
				},
				error: function(){
					mui.toast('数据获取失败');
				}
			})
		}
		// 展示动火申请数据
		function setApprovalValue(data) {
			data = data[0];
			var fields = ['PermitCode', 'ProjectCompanyName', 'ApplyCompanyName', 'FireWorkRegion', 'FirePositions', 'FireApparatus', 'JobLevel', 'JobType', 'ProjectName', 'SupervisionUserName', 'ValidTime', 'ApplyUserName', 'ApplyTime'];
			
			for(var i = 0; i < fields.length; i++) {
				var field = fields[i],
					id = 'approval.' + field,
					dom = document.getElementById(id),
					value;
				
				if(field == 'ValidTime') {
					var startTime = featureCommon.formatTime(data.StartTime),
							endTime = featureCommon.formatTime(data.EndTime);
						value = startTime + ' 至 ' + endTime;
				}else {
					value = data[field];
				}
				
				if(/Time/.test(field) && field != 'ValidTime') {
					value = featureCommon.formatTime(value);
				}
				
				dom.innerHTML = value;
			}
		}
		// 动火申请提交意见
		function addEvent(PermitID){
			var btn = document.getElementById('AuditBtn');
			var url = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/SendData/FW_FireWorkPermit_AuditOne_Client_IIS?dataKey=00-00-00-00';
			
			btn.onclick = function() {
				//
				if(!validAuditForm()){
					return;
				}
				//审批意见 0通过 、1未通过
				var AuditExplain = document.querySelector('[name="AuditExplain"]:checked').value;
				//审批意见选择通过该参数传3，不通过传2
				var WorkStatus = AuditExplain === '0' ? '3' : '2';
				
				var data = {
					PermitID: PermitID,
					AuditTime: featureCommon.formatTime(new Date(), true),
					AuditExplain: AuditExplain,
					AuditDescript: document.getElementById('AuditDescript').value,
					WorkStatus: WorkStatus,
					ModifiedBy: localStorage.getItem('UserID')
				};
				console.log('动火审批参数', JSON.stringify(data));
				mui.ajax(url, {
					type: 'post',
					data: JSON.stringify(data),
					dataType: 'json',
					headers:{
						'Content-Type':'application/json'
					},
					processData: false,
					success: function (response){
						console.log('动火审批提交', JSON.stringify(response));
						if(response.Summary.StatusCode == 100) {
							mui.toast('审批成功');
						}else{
							mui.toast('审批失败');
						}
						mui.back();
					},
					error: function () {
						console.log(JSON.stringify(arguments));
						mui.toast('审批失败');
					}
				})
			}
		}
		// 验证表单
		function validAuditForm(){
			//var AuditDescript = document.getElementById('AuditDescript');  //意见可为空
			var result = document.querySelector('[name="AuditExplain"]:checked');  //结果
			if(!result) {
				mui.toast('请填写审批结果');
				return false;
			}
			/*if(!AuditDescript.value.trim()){
				mui.toast('请填写审批意见');
				return false;
			}*/
			return true;
		}
		
		//获取特种操作证
		function getCertificateData(RegisterID) {
			var url = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/GetData/FW_GetFireCertificateDetail_Client_IIS?dataKey=00-00-00-00';
			var data = {
				RegisterID: RegisterID
			}; 
			
			mui.ajax(url, {
				type: 'get',
				dataType: 'json',
				data: data,
				success: function (response) {
					plus.nativeUI.closeWaiting();
					var data = response.DataSource.Tables[0].Datas;
					console.log('动火审批中的证照详情', JSON.stringify(data));
					setCertificateValue(data);
				},
				error: function() {
					mui.toast('详情获取失败');
				}
			});
		}
		// 设置特种操作证值
		function setCertificateValue(data) {
			data = data[0];					
				
			var fields = ['CertificateCode','CertificateName','IssuingAuthority','ProjectCompanyName','Remark','UserName','Gender','JobProject','CertificateDate','ValidityStartDate','ValidityEndDate','ReviewDate','IDCard','Mobile','Url', 'AuditUserName','ProjectCompanyName'];
			for(var i = 0; i < fields.length; i++){
				var field = fields[i],
					dom = document.getElementById(field),
					value = data[field];
				
				if(/Date/.test(field)) {
					value = featureCommon.formatDate(value);
				}
				
				if(field == 'Gender') {
					value = featureCommon.getGender(value);
				}
				
				if(field == 'Url') {
					dom.innerHTML = featureCommon.getImgs(value, data.Title);
					continue;
				}
				
				if(field == 'ProjectCompanyName' || field == 'AuditUserName') {
					dom.innerHTML = value;
					continue;
				}
				
				dom.value = value;
			}
		}
		</script>
	</body>
</html>