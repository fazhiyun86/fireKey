<!doctype html>
<html>

	<head>   
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/feature_page_order.css"/>
		<style type="text/css">
			.feature{
				background: url("images/header_base_01.png");
    			background-size: 100%;
  				background-repeat: no-repeat;
  				height: 55px;
  				line-height: 55px;
			}
			
			.mui-bar .mui-icon{
				padding-top: 15px;
			}
		</style>
	</head>

	<body>
		<!--侧滑菜单容器-->
			<!-- 侧滑导航根容器 -->
			<div id="offCanvasWrapper" class="mui-off-canvas-wrap mui-draggable mui-slide-in">
				<!-- 菜单容器 -->
				<aside id="offCanvasSide" class="mui-off-canvas-right">
					<div id="offCanvasSideScroll" class="mui-scroll-wrapper">
					    <div id="area_con" class="mui-scroll" style="color:#000000;">
					        <header>
					        	<div>区域选择</div>
					        </header>
					        <div id="area_con_list" class="area_con_list">
					        	<!--<div class="lis">-->
					        	<!--<div class="lists">
					        		
					        		<div id="topid" class="listTop">
					        			<div class="list_bt">
					        			<p class="p1">行政办公区A1工程</p>
					        			<p class="p2">北京城建集团</p>
					        			</div>
					        			<span id="show" class="show"><img src="images/arrow_2.png"/></span>
					        		</div>
					        		<ul id="hide" class="list_del">
					        			<li>东区-1号楼</li>
					        			<li>东区-2号楼</li>
					        			<li>东区-3号楼</li>
					        			<li>东区-4号楼</li>
					        		</ul>
					        	</div>
					        	
					        	<div class="lists">
					        		
					        		<div id="topid" class="listTop">
					        			<div class="list_bt">
					        			<p class="p1">行政办公区A1工程</p>
					        			<p class="p2">北京城建集团</p>
					        			</div>
					        			<span id="show" class="show"><img src="images/arrow_2.png"/></span>
					        		</div>
					        		<ul id="hide" class="list_del">
					        			<li>东区-1号楼</li>
					        			<li>东区-2号楼</li>
					        			<li>东区-3号楼</li>
					        			<li>东区-4号楼</li>
					        		</ul>
					        	</div>
					        	
					        	<div class="lists">
					        		
					        		<div id="topid" class="listTop">
					        			<div class="list_bt">
					        			<p class="p1">行政办公区A1工程</p>
					        			<p class="p2">北京城建集团</p>
					        			</div>
					        			<span id="show" class="show"><img src="images/arrow_2.png"/></span>
					        		</div>
					        		<ul id="hide" class="list_del">
					        			<li>东区-1号楼</li>
					        			<li>东区-2号楼</li>
					        			<li>东区-3号楼</li>
					        			<li>东区-4号楼</li>
					        		</ul>
					        	</div>-->
					        	
					        </div>
					        	
					    </div>
					</div>
				</aside>
				<!-- 主页面容器 -->
				<div class="mui-inner-wrap">
					<div  id="offCanvasContentScroll" class="mui-content mui-scroll-wrapper">	
						<header class="mui-bar mui-bar-nav feature">
						    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
						    <h1 class="mui-title">整改通知</h1>
						</header>			
						<div class="mui-content inform">
						    <div class="inform_con">
						    	<div class="p_text">整改单号：EXAMR201703281488987</div>	
						    	<div class="p_tit">
						    		<legend>通知名称：</legend>
						    		<input class="informName" type="text" name="" id="" value="" />
						    	</div>		  
						    	<div class="p_tit tit2">
						    		<legend>整改对象：</legend>
						    		<input class="areadx" type="text" name="" id="zhenggaidx" value=""/>
						    		<span  id="aresChoose" class="obje" style="display: block; width: 6px; height: 6px;"><img src="images/arrow_r.png" style="width: 100%; height: auto;"/></span>
						    	</div>			     	
						    	<div class="p_inp">
						    		<p>整改内容：</p>
						    		<textarea class="changeCon" name="txt" clos="100" rows="3" warp="virtual" placeholder=""></textarea>
						    	</div>		    	
						    	<div class="p_inp">
						    		<p>整改说明：</p>
						    		<textarea class="changeInf" name="txt" clos="100" rows="3" warp="virtual" placeholder=""></textarea>
						    	</div>
						    	<div class="border_line"></div>
						    	<div id="time_limit" style="width: 100%; height: auto;" data-time="">整改期限：2017年8月27日&nbsp;&nbsp;19时30分<span class="timer" style="display: block; width: 7px; height: 7px;" href="#popover" id="openPopover" class="mui-btn mui-btn-primary mui-btn-block"><img src="images/arrow_r.png" style="width: 100%; height: auto;"/></span>
						    	</div>
					
						    </div>
						    <button id="btn"><a href="javascript:;">下达通知</a></button>
						    <div id="complete">整改通知已下达</div>
						</div>
						<!-- off-canvas backdrop -->
						<div class="mui-off-canvas-backdrop"></div>
				    </div>  
				</div>
			</div>
		
		<!--时间弹出框-->
		<!--<div id="popover" class="mui-popover" style="background: #007AFF;">-->
		  <!--时间弹出-->
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/mui.picker.min.js"></script>
		<script src="js/common.js"></script>
		<script type="text/javascript">
			(function(){
				mui.init({
					swipeBack: false,
				});
				
				mui(".mui-scroll-wrapper").scroll({
					bounce: false,//滚动条是否有弹力默认是true
					indicators: false, //是否显示滚动条,默认是true
				});
				
				mui.plusReady(function() {
					var selfView = plus.webview.currentWebview();
//					OrganiseUnitID = selfView.info.id;
					setSubCompany()
				});
				
				/**
				 * 获取自己以及下属单位
				 */
				function setSubCompany () {
			
					var data = {
						OrganiseUnitID: localStorage.getItem("UserOrganiseUnitID"),

					}
						console.log( localStorage.getItem("UserOrganiseUnitID"))
					
					urlg = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/GetData/TZDH_WebApp_GetChildrenOrganiseUnitAndRegion?dataKey=00-00-00-00';
					
					mui.ajax(urlg, {
						data: data, 
						dataType: 'json',
						type: 'get',
						timeout: 5000,
						success: function(data){
//							data1 = data1['DataSource']['Tables'][0]['Datas'];
//							data2 = data1['DataSource']['Tables'][1]['Datas'];
							data = data['DataSource']['Tables']
							 
							var t = common.formateArea(data);
							setSubCompanyHtml(t)
						},
						error: function(){
							mui.toast('数据请求失败')
							console.log("低风险请求数据失败!")
						}
					});
					
					//侧滑拼接
					function setSubCompanyHtml(data){
						var html = '';
						var len = data.length;
						for( var i=0; i< len; i++ ){
							var item = data[i];
							html += '<div class="lists" data-id=" item.OrganiseUnitID ">'+
						        		'<div id="topid" class="listTop">'+
						        			'<div class="list_bt">'+
						        			'<p class="p1">'+ (item.OrganiseUnitName) +'</p>'+
						        			'<p class="p2">'+ (item.ParentOrganiseUnitName) +'</p>'+
						        			'</div>'+
						        			'<span id="show" class="show"><img src="images/arrow_2.png"/></span>'+
						        		'</div>'+
						        		'<ul id="hide" class="list_del" id="'+item.OrganiseUnitID+'">'+ setLi(item.children) +
						        		'</ul>'+
						        	'</div>';
						}
						
						function setLi(areaData){
							var html = '';
							var len = areaData.length;
							
							for( var j=0; j < len; j++ ){
								var item = areaData[j];
								
						        html += '<li class="areali" data-area="'+ item.RegionID +'">'+ item.FullName +'</li>';
						    }
							return html;
						}
						
					    document.getElementById('area_con_list').innerHTML = html;
					}
				}
				
				//侧滑二级菜单的点击样式
				mui('.area_con_list').on('tap','.lists', function(e){
					if($(this).find("#hide").is(":hidden")){
					    $(this).find("#hide").show();    //如果元素为隐藏,则将它显现
					    $(this).find("img").addClass("rotating")
					}else{
					    $(this).find("#hide").hide();     //如果元素为显现,则将其隐藏
					    $(this).find("img").removeClass("rotating")
					}
				});

				mui.ready(function() {
					//时间选择弹出框
					mui(document).on('tap','#time_limit', function() {
						var dtpicker = new mui.DtPicker({
							"value":"2015-10-10 10:10","beginYear":2010,"endYear":2020
						}) ;
						
						dtpicker.show(function(rs) {
							var timeValue = '整改期限' + ':' + ' ' + rs.y.value + '年' + rs.m.value + '月' + rs.d.value  + '日' + ' ' + ' ' + rs.h.value + '时' + rs.i.value + '分';
							console.log (timeValue);
							$('#time_limit').text(timeValue)
							var timeVal = rs.y.value + '-' + rs.m.value + '-' + rs.d.value  + ' ' + rs.h.value + ':' + rs.i.value;
							$('#time_limit').attr("data-time", timeVal)
						});
					});
	
					//下达通知完成
					document.getElementById("btn").addEventListener('tap', function(e) {
						//请求
						sendRequest();
						if($("#complete").is(":hidden")){
						    $("#complete").show();    //如果元素为隐藏,则将它显现
						}
						
//						setTimeout(function(){						
//						 	window.location.href="feature_page_order_01.html";
//						},2000)
					});
					
					function sendRequest () {
						
						var data = getParams();
						
						urlg = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/GetData/EXAM_ExamineRectify_ImportOne?dataKey=00-00-00-00';
						mui.ajax(urlg, {
							data: data, 
							dataType: 'json',
							type: 'get',
							timeout: 5000,
							success: function(data){
								console.log(JSON.stringify(data)) 
								mui.toast('整改通知已下达')
							},
							error: function(){
								mui.toast('数据请求失败')
								console.log("低风险请求数据失败!")
							}
						});
					};
					
					// 下单通知获取参数
					function getParams () {
						var data = {}
						
						data.OrderName = ''; // 整改单ID
						data.OrderType = '1'; // 整改单类型 1 手动
						data.DataSrcType = ''; // 数据源类型 (1,选择;2,录入）
						
						data.ExamObjectType = ''; //整改对象类型 （1，组织机构；2，检查点）
						
						data.RectifyOrg = ''; // 整改对象ID
						data.RectifyContent = ''; // 整改内容
						data.RectifyDescript = ''; //整改说明
						data.StartTime = ''; //
						data.EndTime = ''; //
						data.OrderUser = ''; //制单人
						data.OrderCompany = ''; //制单单位  
						data.OrderDepartment = ''; //制单部门
						data.TaskID = ''; //检查任务ID   
						data.TaskItemIDs = ''; //检查任务项目ID字符拼接串
						data.ModifiedBy = ''; //登录人ID
						
						data.danHao = $('.p_text').text();
						data.informName = $('.informName').val();
						data.changeCon = $('.changeCon').val();
						data.changeInf = $('.changeInf').val();
						data.changeTime = $('#time_limit').attr('data-time');
						

						
						return data;
					};
					
					//时间弹出窗
					document.getElementById('openPopover').addEventListener('tap', function() {
						mui('.mui-popover').popover('toggle',document.getElementById("openPopover"));
					});
				});
				
				mui(document).on('tap','.areali', function() {

					var areali = $(this).text();
					var dc = $("#zhenggaidx").val(areali);
//					dc.value
//					$('areadx").val(areali);
//						
//					dtpicker.show(function(rs) {
//						var timeValue = '整改期限' + ':  ' + rs.y.value + '年' + rs.m.value + '月' + rs.d.value  + '日' + rs.h.value + '时' + rs.i.value + '分';
//						console.log (timeValue);
//						$('#time_limit').text(timeValue)
//						var timeVal = rs.y.value + '-' + rs.m.value + '-' + rs.d.value  + ' ' + rs.h.value + ':' + rs.i.value;
//						$('#time_limit').attr("data-time", timeVal)
//					});
				});
//						
				//侧滑容器父节点
				var offCanvasWrapper = mui('#offCanvasWrapper');

				document.getElementById('zhenggaidx').addEventListener('tap', function() {
					offCanvasWrapper.offCanvas('show');
				});				

				 //主界面和侧滑菜单界面均支持区域滚动；
				mui('#offCanvasSideScroll').scroll();
				mui('#offCanvasContentScroll').scroll();
				
				 //实现ios平台的侧滑关闭页面；
				if (mui.os.plus && mui.os.ios) {
					offCanvasWrapper[0].addEventListener('shown', function(e) { //菜单显示完成事件
						plus.webview.currentWebview().setStyle({
							'popGesture': 'none'
						});
					});
					offCanvasWrapper[0].addEventListener('hidden', function(e) { //菜单关闭完成事件
						plus.webview.currentWebview().setStyle({
							'popGesture': 'close'
						});
					});
				}
				
			})();
		</script>
	</body>

</html>