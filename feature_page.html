<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/feature_page.css"/>
		<style type="text/css">
			.feature{
				height: 3.1rem;
				line-height: 3.1rem;
				padding-top: 0.3rem;
				background: url("images/header_base_01.png");
    			background-size: 100%;
  				background-repeat: no-repeat;
			}
			
			.feature h1{
				width: 11rem;
				float: left;
				font-size: 1.1rem;
				color: #FFFFFF;
				float: left;
			}
			
			.feature span{
				display: block;
				float: right;
				color: #FFFFFF;
				font-weight: 800;
			}
			
			.feature_grid{
				margin-top: 3.5rem;
			}
			
			#feature_grid_list{
				text-align: center;
			}
			
			.mui-table-view .mui-grid-view 
			.mui-table-view-cell .mui-media-body {
				font-size: 0.9rem;
			}
			
			#feature_grid_list li{
				float: left;
			}
			
			#feature_grid_list li>a>span{
				display: block;
				width: 40px;
				height: 40px;
			}
			
			#feature_grid_list li>a>span img{
				width: 100%;
				height: auto;
			}

			#feature_grid_list li>a>div{
				font-size: 0.75rem;
			}
			
			.hide {
				display: none!important;
			}
			.mui-table-view.mui-grid-view .mui-table-view-cell .mui-media-body {
				height: 30px;
			}
			.mui-grid-view.mui-grid-9 .mui-table-view-cell {
				padding: 10px 15px 0px;
			}
			.media-title {
				color: #5E5E5E;
			}
			.media-desc {
				color: #939393;
				font-size: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav feature">
		    <h1 class="mui-title">功能</h1>
		</header>
		<div class="feature_grid">
			<ul id="feature_grid_list" class="mui-table-view mui-grid-view mui-grid-9 " style="background-color: none;">
				<li id="grid_list8" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_8" href="#">
				        <span class="mui-icon"><img src="images/icon_zhenggaicuiban.png" /><span id="count_ToUrge" class="mui-badge mui-badge-red">0</span></span>
				        <div class="mui-media-body">
				        	<p class="media-title">整改催办</p>
				        	<p class="media-desc">监督员对隐患整改提醒</p>
				        </div>
				    </a>
				</li>
				<li id="grid_list" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_1" href="#">
				        <span class="mui-icon"><img src="images/icon_zhenggaiyanshou.png" /><span id="count_RectifyAccept" class="mui-badge mui-badge-red">0</span></span>
				        <div class="mui-media-body">
				        	<p class="media-title">整改验收</p>
				        	<p class="media-desc">决定整改是否完成</p>
				        </div>
				    </a>
				</li>
				<li id="grid_list2" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_2" href="#">
				        <span class="mui-icons"><img src="images/icon_xiadazhenggai.png" /></span>
				        <div class="mui-media-body">
				        	<p class="media-title">整改下单</p>
				        	<p class="media-desc">下达整改通知书</p>
				        </div>
				    </a>
				</li>
				
				<li id="grid_list4" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_4" href="#">
				        <span class="mui-icon"><img src="images/icon_zhengzhaochaxun.png" /></span>
				        <div class="mui-media-body">
				        	<p class="media-title">证照查询</p>
				        	<p class="media-desc">查询特种作业证书</p>
				        </div>
				    </a>
				</li>
				<li id="grid_list5" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_5" href="#">
				        <span class="mui-icon"><img src="images/icon_zhengzhaoshenhe.png" /><span id="count_CertificateAudit" class="mui-badge mui-badge-red">0</span></span>
				        <div class="mui-media-body">
				        	<p class="media-title">证照审核</p>
				        	<p class="media-desc">审核特种作业证书</p>
				        </div>
				    </a>
				</li>
				<li id="grid_list6" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_6" href="#">
				        <span class="mui-icon"><img src="images/icon_donghuozhengshenpi.png" /><span id="count_PermitAudit" class="mui-badge mui-badge-red">0</span></span>
				        <div class="mui-media-body">
				        	<p class="media-title">动火审批</p>
				        	<p class="media-desc">对动火证进行审批</p>
				        </div>
				    </a>
				</li>
				<!--20171209隐藏-->
				<!--<li id="grid_list7" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_7" href="#">
				        <span class="mui-icon"><img src="images/weixiushenpi.png" /><span id="rushCount" class="mui-badge mui-badge-red">5</span></span>
				        <div class="mui-media-body">维修审批</div>
				    </a>
				</li>-->
				<!--20171125新增-->
				<li id="grid_list3" class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
				    <a class="feature_list_3" href="#">
				        <span class="mui-icon"><img src="images/icon_weixiushenpi.png" /><span id="count_RepairAudit" class="mui-badge mui-badge-red">0</span></span>
				        <div class="mui-media-body">
				        	<p class="media-title">维修审批</p>
				        	<p class="media-desc">对设备维修单审批</p>
				        </div>
				    </a>
				</li>
			</ul>
		</div>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			
			(function(){
				
				// 在回退的时候重新请求角标的数字
				window.addEventListener('featureRefresh', function(e){//执行刷新
					
					changeCount();
					
				});
				
				mui.plusReady(function() { 
					var selfView = plus.webview.currentWebview();
					//changeCount();
				})
				
				mui.ready(function() {
					setTimeout(function(){
						changeCount();
					}, 2000);
					
					//点击进入详情页面
					//整改验收
					mui('#grid_list').on('tap', '.feature_list_1', function() {		
						mui.openWindow({
							url: 'feature_page_audit.html',
							id: 'feature_page_audit.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					});
					
					//整改下单
					mui('#grid_list2').on('tap', '.feature_list_2', function() {
						
						mui.openWindow({
							url: 'feature_page_order.html',
							id: 'feature_page_order.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					});
					
				//	维修审批
					mui('#grid_list3').on('tap', '.feature_list_3', function() {
						mui.openWindow({
							url: 'feature_page_approve.html',
							id: 'feature_page_approve.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})
					// 证照查询	
					mui('#grid_list4').on('tap', '.feature_list_4', function() {
						mui.openWindow({
							url: 'feature_licence_search.html',
							id: 'feature_licence_search.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})
					// 证照审核
					mui('#grid_list5').on('tap', '.feature_list_5', function() {
						mui.openWindow({
							url: 'feature_licence_check.html',
							id: 'feature_licence_check.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})
					// 动火审批
					mui('#grid_list6').on('tap', '.feature_list_6', function() {
						mui.openWindow({
							url: 'feature_fire_approve.html',
							id: 'feature_fire_approve.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})
					// 维修审批
/*					mui('#grid_list7').on('tap', '.feature_list_7', function() {
						mui.openWindow({
							url: 'feature_repair.html',
							id: 'feature_repair.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})*/
					
					// 整改催办
					mui('#grid_list8').on('tap', '.feature_list_8', function() {
						mui.openWindow({
							url: 'Change_Rush.html',
							id: 'Change_Rush.html',
							styles: {
								top: 0, //新页面顶部位置
								bottom: 0, //新页面底部位置
							},
							extras: {
	
							},
							show: {
								duration: '300'
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								title: '加载中...', //等待对话框上显示的提示内容
							}
						});
					})
				})
				
				
				//整改审批总数		
				function changeCount(){
					var data = {
						UserID:localStorage.getItem("UserID"),
						OrganiseUnitID: localStorage.getItem('UserOrganiseUnitID')
					};
					var url = 'http://' + localStorage.getItem("serverAddress") + ':' + localStorage.getItem("portNum") + '/WebApi/DataExchange/GetData/';
					url += 'TZDH_WebApp_ActionTaskCount?dataKey=00-00-00-00';
					
					mui.ajax(url,{
						data: data,
						dataType: 'json',
						type: 'get',
						timeout: 5000,
						success: function (data){
							console.log(JSON.stringify(data));
							if(data.Summary.StatusCode != '100') { return; }
							data = data["DataSource"]["Tables"][0]["Datas"];
							console.log('角标获取' + JSON.stringify(data));
							setHtml(data);
						},
						error: function(){
							console.log('请求错误');
						}						
					});
					/*var data = [
						{ActionCode: 'ToUrge',ActionCount: '5'},
						{ActionCode: 'RectifyAccept',ActionCount: '5'},
						{ActionCode: 'CertificateAudit',ActionCount: '5'},
						{ActionCode: 'PermitAudit',ActionCount: '5'},
						{ActionCode: 'RepairAudit',ActionCount: '5'}
					]*/
					function setHtml(data){
						if(!data.length) return;
						for (var i = 0; i < data.length; i++) {
							var item = data[i];
							var ActionCode = item.ActionCode;
							var id = 'count_' + ActionCode;
							
							if (item.ActionCount=='0' || item.ActionCount=='') {
								document.getElementById(id).style.display = 'none';
								continue;
							}
							document.getElementById(id).innerHTML = item.ActionCount;
						}
					}
				};
				
			})();
		</script>
		
	</body>

</html>